<html>
<head><title>Sensor and video stream access example</title>
<style>
body{
	padding:0;
	margin:0;
	background-color: rgb(222,242,253);
}
iframe {
	border:0;
	margin:0;
	padding:0;
	display:block;
	margin:10px;
	width:640px;
	height:320px;
}
#viewlink {
	width:400px;
}
#container {
	display:block;
	padding:0px;
}
input{
	padding:5px;
	margin:5px;
}
button{
	padding:5px;
	margin:5px;
}
canvas{
	width:100%;
	display:block;
	margin:0;
	padding:0;
}
</style>
</head>
<body>


<canvas id="canvas" style="display:none;max-height:70vh;max-width:calc(70vh*1.777);width:100%;height:100%;" width="1920" height="1080" ></canvas>
<input placeholder="Enter a VDO.Ninja View URL here" id="viewlink" style="display:block;" onchange="loadIframe();"/>
<label for="hori">FOA-Horizontal</label>
<input type="range" id="hori" name="hori" value="63" title="63"  min="40" max="80" title="67" onchange="updateHor(this);">
<label for="vert">FOA-Vertical</label>
<input type="range" id="vert" name="vert" value="50" title="50"  min="30" max="70" onchange="updateVer(this);">
<label for="draw">Draw Delay</label>
<input type="range" id="draw" name="draw" value="110" title="110" min="0" max="500" style="width:500px" onchange="updateDelay(this);"><br /><br />
Add &sensor to the push link to send data; see: <a target="_blank" href="https://docs.vdo.ninja/source-settings/sensor">https://docs.vdo.ninja/source-settings/sensor</a>
<div id="container">

</div>

<script>
// https://www.camerafv5.com/devices/manufacturers/google/pixel_4a_sunfish_1/ ; pixel 4a specs
var horFOA = 49.6;
var verFOA = 63.3;
var drawDelay = 110;
function updateHor(hor){
	horFOA = parseInt(hor.value);
	hor.title = horFOA;
}
function updateVer(ver){
	verFOA = parseInt(ver.value);
	ver.title = verFOA;
}
function updateDelay(time){
	drawDelay = parseInt(time.value);
	time.title = drawDelay;
}
function loadIframe(url=false){  // this is pretty important if you want to avoid camera permission popup problems.  You can also call it automatically via: <body onload=>loadIframe();"> , but don't call it before the page loads.

	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext('2d');
	ctx.imageSmoothingEnabled= false;
	var iframe = document.createElement("iframe");
	var iframeContainer = document.createElement("div");
	
	if (url){
		var iframesrc = url;
	} else {
		var iframesrc = document.getElementById("viewlink").value;
	}
	console.log(iframesrc);
	document.getElementById("viewlink").parentNode.removeChild(document.getElementById("viewlink"));
	document.getElementById("canvas").style.display="block";
	iframe.allow = "autoplay;camera;microphone;fullscreen;picture-in-picture;";

	if (iframesrc==""){
		iframesrc="./";
	}
	
	iframe.src = iframesrc;
	
	iframeContainer.appendChild(iframe);
	
	document.getElementById("container").appendChild(iframeContainer);

	var videos = iframe.contentWindow.document.querySelectorAll("video");
	var sensors = {};
	
	function appendTextLine(container, text, indentLevel){
		var line = document.createElement("div");
		if (indentLevel){
			line.style.marginLeft = (indentLevel * 12) + "px";
		}
		line.textContent = text;
		container.appendChild(line);
	}
	
	function appendKeyValueList(container, obj, indentLevel){
		indentLevel = indentLevel || 0;
		for (var key in obj) {
			if (!Object.prototype.hasOwnProperty.call(obj, key)) {
				continue;
			}
			var value = obj[key];
			if (typeof value === "object" && value !== null) {
				appendTextLine(container, key + ":", indentLevel);
				appendKeyValueList(container, value, indentLevel + 1);
			} else {
				appendTextLine(container, key + ": " + value, indentLevel);
			}
		}
	}
	
	function getOrCreateOutput(id, borderStyle){
		var element = id ? document.getElementById(id) : null;
		if (element){
			element.textContent = "";
			return element;
		}
		var div = document.createElement("div");
		if (borderStyle){
			div.style.border = borderStyle;
		}
		if (id){
			div.id = id;
		}
		iframeContainer.appendChild(div);
		return div;
	}
	
	function drawFrame(vid){
		try {
			if (sensors.mag){ // androids may not support this.
				var angle = 1.5 * Math.PI - Math.atan2(sensors.mag.y,sensors.mag.x);
				var startPixel = (angle / ( 2 * Math.PI)) * 1920;
				var endPixel = (verFOA/360) * 1920 + startPixel;
			} else if (sensors.ori){ 
				var angle = sensors.ori.a;
				var frontToBack = sensors.ori.b;
				var leftToRight = sensors.ori.g;
				
				var startPixel = Math.floor((angle / 360) * 1920);
				var width = Math.floor((verFOA/360) * 1920);
				var height = vid.videoHeight*(width/vid.videoWidth);
				
				var h_offset = Math.floor(((frontToBack+(verFOA/2))/180 * 1080)-540);
				var w_offset = Math.floor((leftToRight+horFOA)/180 * 1920);
			}
			
			setTimeout(function(a1,a2,a3,a4,a5){
			
				ctx.filter = 'blur(4px)';
				ctx.drawImage(a1,a2,a3,a4,a5);
				
				ctx.filter = "none";
				ctx.drawImage(a1,a2,a3,a4,a5);
				
			}, drawDelay, vid, startPixel-w_offset, h_offset, width, height);
		} catch(e){console.error(e);}
	};
	
	setInterval(function(){
		if (videos.length){
			if ("UUID" in sensors){
				if (videos[0].id !== "videosource_"+sensors.UUID){
					videos = iframe.contentWindow.document.querySelectorAll("video#videosource_"+sensors.UUID);
				} 
				if (videos.length){
					drawFrame(videos[0]);
				}
			}
		}
	},100);
	
	
	////////////  LISTEN FOR EVENTS

	var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
	var eventer = window[eventMethod];
	var messageEvent = eventMethod === "attachEvent" ? "onmessage" : "message";


	/// If you have a routing system setup, you could have just one global listener for all iframes instead.
	
	eventer(messageEvent, function (e) {
		if (e.source != iframe.contentWindow){return} // reject messages send from other iframes
		
		if ("stats" in e.data){
			var statsBox = document.createElement("div");
			appendTextLine(statsBox, "total_inbound_connections: " + e.data.stats.total_inbound_connections);
			appendTextLine(statsBox, "total_outbound_connections: " + e.data.stats.total_outbound_connections);
			
			for (var streamID in e.data.stats.inbound){
				if (!Object.prototype.hasOwnProperty.call(e.data.stats.inbound, streamID)){
					continue;
				}
				var streamHeader = document.createElement("div");
				streamHeader.style.marginTop = "8px";
				var streamLabel = document.createElement("strong");
				streamLabel.textContent = "streamID:";
				streamHeader.appendChild(streamLabel);
				streamHeader.appendChild(document.createTextNode(" " + streamID));
				statsBox.appendChild(streamHeader);
				appendKeyValueList(statsBox, e.data.stats.inbound[streamID], 1);
			}
			
			iframeContainer.appendChild(statsBox);
		}
		
		if ("gotChat" in e.data){
			var chatBox = document.createElement("div");
			chatBox.textContent = e.data.gotChat.msg;
			chatBox.style.border="1px dotted black";
			iframeContainer.appendChild(chatBox);
		}
		
		if ("action" in e.data){
			var actionBox = document.createElement("div");
			appendTextLine(actionBox, "child-page-action: " + e.data.action);
			actionBox.style.border="1px dotted black";
			iframeContainer.appendChild(actionBox);
			console.log(e.data.action);
			
			if (e.data.action == "new-view-connection"){
				setTimeout(function(){
					videos = iframe.contentWindow.document.querySelectorAll("video");
					console.log(videos);
				},500);
			}
		}
		
		
		if ("streamIDs" in e.data){
			var streamBox = document.createElement("div");
			streamBox.style.border="1px dotted black";
			appendTextLine(streamBox, "child-page-action: streamIDs");
			for (var key in e.data.streamIDs) {
				if (!Object.prototype.hasOwnProperty.call(e.data.streamIDs, key)){
					continue;
				}
				appendTextLine(streamBox, "streamID: " +  key + ", label: " + e.data.streamIDs[key], 1);
			}
			iframeContainer.appendChild(streamBox);
		}
		
		if ("loudness" in e.data){
			var loudnessBox = getOrCreateOutput("loudness", "1px dotted black");
			appendTextLine(loudnessBox, "child-page-action: loudness");
			for (var key in e.data.loudness) {
				if (!Object.prototype.hasOwnProperty.call(e.data.loudness, key)){
					continue;
				}
				appendTextLine(loudnessBox, key + " Loudness: " +  e.data.loudness[key], 1);
			}
			loudnessBox.style.border="1px black";
			
		}
		
		if ("sensors" in e.data){
			sensors = e.data.sensors;
			var sensorsBox = getOrCreateOutput("sensors", "1px dotted black");
			appendTextLine(sensorsBox, "child-page-action: sensors");
			for (var sensorKey in e.data.sensors) {
				if (!Object.prototype.hasOwnProperty.call(e.data.sensors, sensorKey)){
					continue;
				}
				var sensorValue = e.data.sensors[sensorKey];
				if (typeof sensorValue === "object" && sensorValue !== null){
					appendTextLine(sensorsBox, sensorKey + ":", 0);
					appendKeyValueList(sensorsBox, sensorValue, 1);
				} else {
					appendTextLine(sensorsBox, sensorKey + ": " + sensorValue, 0);
				}
			}
			sensorsBox.style.border="1px black";
		}
	});
}


</script>
</body>
</html>
